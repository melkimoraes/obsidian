- [x]  ver ações agendadas se estao rodando
- [x] cliente paga uma parte no pix , e no credito.
- [x] vou tenta ver fonte do multiplar por titulos. ❌
- [x] erick vai ver -> mas provavelmente o cliente vai informar como parametro -> o valor do link da cielo o restante eu setaria um campo AD que eu jogo na formula tb! teria uma parcela como PIX nesse valor restante!
- [x] acompanhar pra ver se ta consultando link e baixando os financeiros depois!
- [x] marcação no tipo de titulo cielo -> vai pegar os financeiros com esse tipo de titulo pra baixar
- [x] primeira requisicao no dia dá erro!?
- [x] ver aquele numero unico que é orçamento se vai baixar automatico ou nao!
- [x] trigger da cielo nova -> TRG_IUD_TGFITE_CIELO
	- [x] preciso ver essa trigger!! delete da tgfcab da pau, pq nao consigo achar o TIPMOV no delete da cab!! a nota parece que ja foi excluida da tgfcab!
	- [x] talvez criar uma regra de negocio caso financeiro <> do valor total da nota??
- [x] mudar trava e geraçao de link cielo bioclean?? quando confirmar o pedido? e só fatura se tiver pago

SELECT DISTINCT NUNOTA,AD_IDCIELO 
FROM TGFCAB 
WHERE STATUSNOTA='L' 
AND 
(
NUNOTA IN (SELECT DISTINCT NUNOTA FROM TGFVAR WHERE NUNOTAORIG IN (SELECT NUNOTA FROM AD_INTCIELOLINK WHERE PAGO='S' AND NVL(BAIXADO,'N')='N'))
OR 
NUNOTA IN (SELECT DISTINCT NUNOTA FROM TGFVAR WHERE NUNOTAORIG IN (SELECT DISTINCT NUNOTA FROM TGFVAR WHERE NUNOTAORIG IN (SELECT NUNOTA FROM AD_INTCIELOLINK WHERE PAGO='S' AND NVL(BAIXADO,'N')='N')))
) 
AND TIPMOV='V'


ver se tem pedido com ad_cielolink que nao é dele!
SELECT NUNOTA,AD_IDCIELO,codtipoper,tipmov,AD_PARCELACIELO,CODTIPVENDA FROM TGFCAB WHERE TIPMOV = 'P' AND AD_IDCIELO <> NUNOTA AND CODTIPVENDA = 41

ver se tem nota com o ad_cielolink inserido porem nao é do pedido dele:
SELECT * FROM TGFCAB
WHERE TIPMOV='V' 
AND AD_IDCIELO <> NVL((SELECT DISTINCT NUNOTAORIG FROM TGFVAR WHERE NUNOTA = TGFCAB.NUNOTA),0) 
AND CODTIPVENDA = 41

ver as notas de vendas que nao tiverem com informaçao da cielo do pedido vinculado:
SELECT 
*
FROM TGFCAB WHERE NUNOTA IN (SELECT NUNOTA FROM TGFVAR WHERE NUNOTAORIG IN (SELECT NUNOTA FROM AD_INTCIELO)) AND AD_IDCIELO IS NULL

ver as notas que vai entrar na baixa automatico:
SELECT DISTINCT CAB.NUNOTA AS NUNOTA,CAB.AD_IDCIELO AS AD_IDCIELO,
(SELECT VLRNOTA FROM TGFCAB WHERE NUNOTA = (SELECT DISTINCT NUNOTAORIG FROM TGFVAR WHERE NUNOTA=CAB.NUNOTA)) AS VLRPEDIDO,
(SELECT SUM(VLRDESDOB) FROM TGFFIN WHERE NUNOTA = CAB.NUNOTA AND RECDESP=1) AS VLRTOTALFIN
FROM TGFCAB CAB
WHERE CAB.STATUSNOTA='L' 
AND 
(
CAB.NUNOTA IN (SELECT DISTINCT NUNOTA FROM TGFVAR WHERE NUNOTAORIG IN (SELECT NUNOTA FROM AD_INTCIELOLINK WHERE PAGO='S' AND NVL(BAIXADO,'N')='N'))
OR 
CAB.NUNOTA IN (SELECT DISTINCT NUNOTA FROM TGFVAR WHERE NUNOTAORIG IN (SELECT DISTINCT NUNOTA FROM TGFVAR WHERE NUNOTAORIG IN (SELECT NUNOTA FROM AD_INTCIELOLINK WHERE PAGO='S' AND NVL(BAIXADO,'N')='N')))
) 
AND CAB.TIPMOV='V' AND CAB.STATUSNFE='A'

divergencia de valor dos financeiros total da nota de venda e valor total do pedido da cielo
SELECT 
CAB.NUNOTA , CAB.CODEMP, (SELECT NOMEPARC FROM TGFPAR WHERE CODPARC = CAB.CODPARC) AS NOMEPARC, CAB.VLRNOTA, (SELECT SUM(VLRDESDOB) FROM TGFFIN WHERE NUNOTA = CAB.NUNOTA AND RECDESP=1) AS VLRFIN,
(SELECT VLRNOTA FROM TGFCAB WHERE NUNOTA = (SELECT DISTINCT NUNOTAORIG FROM TGFVAR WHERE NUNOTA=CAB.NUNOTA)) AS VLRNOTAPEDIDO, CAB.VLRFRETE,
(SELECT SUM(VLRDESDOB) FROM TGFFIN WHERE NUNOTA = CAB.NUNOTA AND RECDESP=1) - (SELECT VLRNOTA FROM TGFCAB WHERE NUNOTA = (SELECT DISTINCT NUNOTAORIG FROM TGFVAR WHERE NUNOTA=CAB.NUNOTA)) AS VLRDIVER 
FROM TGFCAB CAB 
WHERE CAB.NUNOTA IN (SELECT NUNOTA FROM TGFVAR WHERE NUNOTAORIG IN (SELECT NUNOTA FROM AD_INTCIELO)) 
AND CAB.AD_IDCIELO IS NOT NULL 
AND (SELECT VLRNOTA FROM TGFCAB WHERE NUNOTA = (SELECT DISTINCT NUNOTAORIG FROM TGFVAR WHERE NUNOTA=CAB.NUNOTA)) <> (SELECT SUM(VLRDESDOB) FROM TGFFIN WHERE NUNOTA = CAB.NUNOTA AND RECDESP=1)
AND (SELECT VLRNOTA FROM TGFCAB WHERE NUNOTA = (SELECT DISTINCT NUNOTAORIG FROM TGFVAR WHERE NUNOTA=CAB.NUNOTA)) = (SELECT AD_VALORCIELO+AD_VALOROUTROS FROM TGFCAB WHERE NUNOTA = (SELECT DISTINCT NUNOTAORIG FROM TGFVAR WHERE NUNOTA=CAB.NUNOTA))
ORDER BY 1

pedidos que tem link gerado e foi trocado:
SELECT * FROM TGFCAB WHERE TIPMOV='P' AND AD_IDCIELO IS NOT NULL AND CODTIPVENDA <> 41

ver link + pix as baixas  e etc:
SELECT NUNOTA,NUFIN,VLRDESDOB,DHBAIXA,VLRBAIXA FROM TGFFIN WHERE NUNOTA IN (
SELECT NUNOTA FROM TGFCAB WHERE NUNOTA IN (
SELECT DISTINCT NUNOTA FROM TGFVAR WHERE NUNOTAORIG IN (
SELECT NUNOTA FROM TGFCAB WHERE TIPMOV='P' AND AD_IDCIELO IS NOT NULL AND AD_VALOROUTROS > 0)
) AND TIPMOV='V' AND CODTIPVENDA=41 AND STATUSNFE='A')
AND RECDESP=1

NOTAS CONFIRMADAS/APROVADAS -> LINKS DA CIELO NAO PAGOS!
7519
3594
6234 

---
trigger importante :
create or replace trigger TRG_IU_TGFCAB_LIMPACIELO
  before INSERT
  on tgfcab 
  for each row
declare
  V_COUNT NUMBER;
begin
  IF :NEW.TIPMOV <> 'V' THEN
    
    :NEW.AD_IDCIELO := NULL;
    :NEW.AD_PARCELACIELO := NULL;
    :NEW.AD_VALORCIELO := NULL;
    :NEW.AD_VALOROUTROS := NULL;
    
  ELSIF :NEW.TIPMOV='V' THEN
    
    SELECT COUNT(1) 
    INTO V_COUNT
    FROM TGFCAB WHERE NUNOTA IN (SELECT DISTINCT NUNOTAORIG FROM TGFVAR WHERE NUNOTA = :NEW.NUNOTA)
    AND AD_IDCIELO IS NOT NULL;
    
    IF V_COUNT = 0 THEN
      :NEW.AD_IDCIELO := NULL;
      :NEW.AD_PARCELACIELO := NULL;
      :NEW.AD_VALORCIELO := NULL;
      :NEW.AD_VALOROUTROS := NULL;
    END IF;
  END IF;
end TRG_IU_TGFCAB_LIMPACIELO;


---
PLSQL -> PRA DAR UPDATE NOS AD_CIELO VAZIO QUE DEVERIA TA PREENCHIDO COM O DA CIELO DO PEDIDO!


DECLARE
V_PARCELACIELO NUMBER;
V_VALORCIELO FLOAT;
V_VALOROUTROS FLOAT; 
V_IDCIELO NUMBER;
BEGIN
  FOR X IN (SELECT DISTINCT CAB.NUNOTA AS NUNOTA
FROM TGFCAB CAB
WHERE CAB.STATUSNOTA='L' 
AND 
(
CAB.NUNOTA IN (SELECT DISTINCT NUNOTA FROM TGFVAR WHERE NUNOTAORIG IN (SELECT NUNOTA FROM AD_INTCIELOLINK WHERE PAGO='S' AND NVL(BAIXADO,'N')='N'))
OR 
CAB.NUNOTA IN (SELECT DISTINCT NUNOTA FROM TGFVAR WHERE NUNOTAORIG IN (SELECT DISTINCT NUNOTA FROM TGFVAR WHERE NUNOTAORIG IN (SELECT NUNOTA FROM AD_INTCIELOLINK WHERE PAGO='S' AND NVL(BAIXADO,'N')='N')))
) 
AND CAB.TIPMOV='V' AND CAB.STATUSNFE='A'
AND TO_NUMBER((SELECT VLRNOTA FROM TGFCAB WHERE NUNOTA IN (SELECT DISTINCT NUNOTAORIG FROM TGFVAR WHERE NUNOTA=CAB.NUNOTA))) = TO_NUMBER((SELECT SUM(VLRDESDOB) FROM TGFFIN WHERE NUNOTA = CAB.NUNOTA AND RECDESP=1 AND NVL(PROVISAO,'N') = 'N'))
AND CAB.AD_IDCIELO IS NULL) LOOP
                    V_PARCELACIELO := 1;
                    V_VALORCIELO:=NULL; 
                    V_VALOROUTROS:=NULL; 
                    V_IDCIELO:=NULL;

                  SELECT  AD_PARCELACIELO,AD_VALORCIELO,AD_VALOROUTROS,AD_IDCIELO 
                  INTO V_PARCELACIELO, V_VALORCIELO, V_VALOROUTROS, V_IDCIELO
                  FROM TGFCAB WHERE NUNOTA = ( SELECT DISTINCT NUNOTAORIG FROM TGFVAR WHERE NUNOTA = X.NUNOTA);
                  
                  UPDATE TGFCAB CAB SET CAB.AD_PARCELACIELO=V_PARCELACIELO, CAB.AD_VALORCIELO=V_VALORCIELO,CAB.AD_VALOROUTROS=V_VALOROUTROS,CAB.AD_IDCIELO=V_IDCIELO WHERE CAB.NUNOTA = X.NUNOTA;

  END LOOP;
END;